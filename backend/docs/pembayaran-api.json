{
    "openapi": "3.1.0",
    "info": {
        "title": "Pembayaran API",
        "description": "Dokumentasi endpoint Pembayaran.",
        "version": "1.0.0"
    },
    "servers": [
        { "url": "http://localhost:8080" }
    ],
    "components": {
        "parameters": {
            "Authorization": {
                "name": "Authorization",
                "in": "header",
                "schema": { "type": "string" },
                "description": "User token dari database"
            },
            "SearchQuery": {
                "name": "search",
                "in": "query",
                "required": false,
                "schema": { "type": "string" },
                "description": "Cari partial kode_pembayaran / nama siswa / nis."
            },
            "PerPageQuery": {
                "name": "per_page",
                "in": "query",
                "required": false,
                "schema": { "type": "integer", "default": 30 },
                "description": "Item per halaman (default 30)."
            },
            "KodeTagihanPath": {
                "name": "kode_tagihan",
                "in": "path",
                "required": true,
                "schema": { "type": "string" },
                "description": "Primary key kode_tagihan."
            },
            "KodePembayaranPath": {
                "name": "kode_pembayaran",
                "in": "path",
                "required": true,
                "schema": { "type": "string" },
                "description": "Primary key kode_pembayaran."
            }
        },
        "schemas": {
            "JenisTagihan": {
                "type": "object",
                "properties": {
                    "id": {"type": "integer"},
                    "nama": {"type": "string"},
                    "jatuh_tempo": {"type": ["string","null"], "format": "date"},
                    "jumlah": {"type": ["string","number"]}
                },
                "required": ["id","nama","jumlah"]
            },
            "PembayaranSiswa": {
                "type": "object",
                "properties": {
                    "id": {"type": "integer"},
                    "nis": {"type": "string"},
                    "nama": {"type": "string"},
                    "jenjang": {"type": ["string","null"]},
                    "kelas": {
                        "type": "object",
                        "properties": {
                            "id": {"type": ["integer"]},
                            "jenjang": {"type": ["string"]},
                            "nama": {"type": ["string"]}
                        }
                    },
                    "kategori": {
                        "type": "object",
                        "properties": {
                            "id": {"type": ["integer"]},
                            "nama": {"type": ["string"]}
                        }
                    }
                },
                "required": ["id","nis","nama"]
            },
            "TagihanUntukPembayaran": {
                "type": "object",
                "properties": {
                    "kode_tagihan": {"type": "string"},
                    "jenis_tagihan": {"$ref": "#/components/schemas/JenisTagihan"},
                    "siswa": {"$ref": "#/components/schemas/PembayaranSiswa"},
                    "tmp": {"type": ["string","number","integer","null"]},
                    "status": {"type": "string"}
                },
                "required": ["kode_tagihan","jenis_tagihan","siswa","status"]
            },
            "Pembayaran": {
                "type": "object",
                "properties": {
                    "kode_pembayaran": {"type": "string"},
                    "kode_tagihan": {
                        "oneOf": [
                            {"type": "string"},
                            {"$ref": "#/components/schemas/TagihanUntukPembayaran"}
                        ]
                    },
                    "tanggal": {"type": "string", "format": "date"},
                    "metode": {"type": "string", "enum": ["Tunai","Non-Tunai"]},
                    "jumlah": {"type": ["number","integer","string"]},
                    "pembayar": {"type": "string"}
                },
                "required": ["kode_pembayaran","kode_tagihan","tanggal","metode","jumlah","pembayar"]
            },
            "Kwitansi": {
                "type": "object",
                "properties": {
                    "setting": {"type": "object"},
                    "tanggal": {"type": "string", "format": "date"},
                    "pembayar": {"type": "string"},
                    "jumlah": {"type": ["number","integer","string"]},
                    "untuk": {"type": "string"},
                    "sejumlah": {"type": "string"}
                },
                "required": ["tanggal","pembayar","jumlah","untuk","sejumlah"]
            },
            "PembayaranBayarRequest": {
                "type": "object",
                "properties": {
                    "jumlah": {"type": "number", "minimum": 1},
                    "metode": {"type": "string", "enum": ["Tunai","Non-Tunai"]},
                    "pembayar": {"type": "string", "maxLength": 100}
                },
                "required": ["jumlah","metode","pembayar"]
            },
            "PembayaranLunasRequest": {
                "type": "object",
                "properties": {
                    "metode": {"type": "string", "enum": ["Tunai","Non-Tunai"]},
                    "pembayar": {"type": "string", "maxLength": 100}
                },
                "required": ["metode","pembayar"],
                "description": "Jumlah diambil dari Tagihan (pembayaran lunas)."
            },
            "ErrorResponse": {
                "type": "object",
                "properties": {
                    "errors": {
                        "type": "object",
                        "properties": {
                            "message": {
                                "type": "array",
                                "items": {"type": "string"}
                            }
                        }
                    }
                },
                "required": ["errors"]
            },
            "ValidationErrorResponse": {
                "type": "object",
                "properties": {
                    "errors": {
                        "type": "object",
                        "additionalProperties": {
                            "type": "array",
                            "items": {"type": "string"}
                        }
                    }
                },
                "required": ["errors"]
            },
            "PembayaranPagination": {
                "type": "object",
                "properties": {
                    "data": {
                        "type": "array",
                        "items": {"$ref": "#/components/schemas/Pembayaran"}
                    },
                    "links": {"type": "object"},
                    "meta": {"type": "object"}
                }
            },
            "PembayaranCollection": {
                "type": "object",
                "properties": {
                    "data": {
                        "type": "array",
                        "items": {"$ref": "#/components/schemas/Pembayaran"}
                    }
                }
            }
        },

    },
    "paths": {
        "/api/pembayaran": {
            "get": {
                "description": "Listing pembayaran (paginate + optional search).",
                "parameters": [
                    {"$ref": "#/components/parameters/Authorization"},
                    {"$ref": "#/components/parameters/SearchQuery"},
                    {"$ref": "#/components/parameters/PerPageQuery"}
                ],
                "responses": {
                    "200": {
                        "description": "Berhasil (data bisa kosong).",
                        "content": {
                            "application/json": {
                                "schema": {"$ref": "#/components/schemas/PembayaranPagination"},
                                "examples": {
                                    "nonEmpty": {
                                        "value": {
                                            "data": [
                                                {
                                                    "kode_pembayaran": "PAY-2511-0001",
                                                    "kode_tagihan": {
                                                        "kode_tagihan": "TAG-2511-0101",
                                                        "jenis_tagihan": {
                                                            "id": 200,
                                                            "nama": "SPP Januari",
                                                            "jatuh_tempo": "2025-01-31",
                                                            "jumlah": "100000.00"
                                                        },
                                                        "siswa": {
                                                            "id": 500,
                                                            "nis": "010100",
                                                            "nama": "Budi Santoso",
                                                            "jenjang": "MI",
                                                            "kelas": {"id": 10, "jenjang": "MI", "nama": "KELAS 1"},
                                                            "kategori": {"id": 12, "nama": "Yatim"}
                                                        },
                                                        "tmp": "50000.00",
                                                        "status": "Belum Lunas"
                                                    },
                                                    "tanggal": "2025-11-22",
                                                    "metode": "Tunai",
                                                    "jumlah": "50000.00",
                                                    "pembayar": "Orang Tua"
                                                },
                                                {
                                                    "kode_pembayaran": "PAY-2511-0002",
                                                    "kode_tagihan": {
                                                        "kode_tagihan": "TAG-2511-0102",
                                                        "jenis_tagihan": {
                                                            "id": 200,
                                                            "nama": "SPP Januari",
                                                            "jatuh_tempo": "2025-01-31",
                                                            "jumlah": "100000.00"
                                                        },
                                                        "siswa": {
                                                            "id": 501,
                                                            "nis": "010101",
                                                            "nama": "Andi Wijaya",
                                                            "jenjang": "MI",
                                                            "kelas": {"id": 10, "jenjang": "MI", "nama": "KELAS 1"},
                                                            "kategori": {"id": 13, "nama": "Piatu"}
                                                        },
                                                        "tmp": "100000.00",
                                                        "status": "Lunas"
                                                    },
                                                    "tanggal": "2025-11-22",
                                                    "metode": "Non-Tunai",
                                                    "jumlah": "100000.00",
                                                    "pembayar": "Wali Murid"
                                                }
                                            ],
                                            "links": {
                                                "first": "http://localhost:8000/api/pembayaran?page=1",
                                                "last": "http://localhost:8000/api/pembayaran?page=1",
                                                "prev": null,
                                                "next": null
                                            },
                                            "meta": {
                                                "current_page": 1,
                                                "from": 1,
                                                "last_page": 1,
                                                "links": [
                                                    {"url": null, "label": "\u00ab Previous", "page": null, "active": false},
                                                    {"url": "http://localhost:8000/api/pembayaran?page=1", "label": "1", "page": 1, "active": true},
                                                    {"url": null, "label": "Next \u00bb", "page": null, "active": false}
                                                ],
                                                "path": "http://localhost:8000/api/pembayaran",
                                                "per_page": 30,
                                                "to": 2,
                                                "total": 2
                                            }
                                        }
                                    },
                                    "empty": {
                                        "value": {
                                            "data": [],
                                            "links": {
                                                "first": "http://localhost:8000/api/pembayaran?page=1",
                                                "last": "http://localhost:8000/api/pembayaran?page=1",
                                                "prev": null,
                                                "next": null
                                            },
                                            "meta": {
                                                "current_page": 1,
                                                "from": null,
                                                "last_page": 1,
                                                "links": [
                                                    {"url": null, "label": "\u00ab Previous", "page": null, "active": false},
                                                    {"url": "http://localhost:8000/api/pembayaran?page=1", "label": "1", "page": 1, "active": true},
                                                    {"url": null, "label": "Next \u00bb", "page": null, "active": false}
                                                ],
                                                "path": "http://localhost:8000/api/pembayaran",
                                                "per_page": 30,
                                                "to": null,
                                                "total": 0
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    },
                    "401": {
                        "description": "Unauthorized.",
                        "content": {
                            "application/json": {
                                "schema": {"$ref": "#/components/schemas/ErrorResponse"},
                                "example": {"errors": {"message": ["unauthorized."]}}
                            }
                        }
                    }
                }
            }
        },
        "/api/pembayaran/bayar/{kode_tagihan}": {
            "post": {
                "description": "Pembayaran cicil (sebagian).",
                "parameters": [
                    {"$ref": "#/components/parameters/Authorization"},
                    {"$ref": "#/components/parameters/KodeTagihanPath"}
                ],
                "requestBody": {
                    "required": true,
                    "content": {
                        "application/json": {
                            "schema": {"$ref": "#/components/schemas/PembayaranBayarRequest"},
                            "example": {"jumlah": 50000, "metode": "Tunai", "pembayar": "Orang Tua"}
                        }
                    }
                },
                "responses": {
                    "200": {
                        "description": "Berhasil membuat pembayaran cicil.",
                        "content": {
                            "application/json": {
                                "schema": {"type": "object", "properties": {"data": {"$ref": "#/components/schemas/Pembayaran"}}},
                                "example": {
                                    "data": {
                                        "kode_pembayaran": "PAY-2511-0101",
                                        "kode_tagihan": {
                                            "kode_tagihan": "TAG-2511-0101",
                                            "jenis_tagihan": {"id": 200, "nama": "SPP Januari", "jatuh_tempo": "2025-01-31", "jumlah": "100000.00"},
                                            "siswa": {"id": 500, "nis": "010100", "nama": "Budi Santoso", "jenjang": "MI", "kelas": {"id": 10, "jenjang": "MI", "nama": "KELAS 1"}, "kategori": {"id": 12, "nama": "Yatim"}},
                                            "tmp": "50000.00",
                                            "status": "Belum Lunas"
                                        },
                                        "tanggal": "2025-11-22",
                                        "metode": "Tunai",
                                        "jumlah": "50000.00",
                                        "pembayar": "Orang Tua"
                                    }
                                }
                            }
                        }
                    },
                    "400": {
                        "description": "Validasi atau overpay gagal.",
                        "content": {
                            "application/json": {
                                "schema": {"$ref": "#/components/schemas/ValidationErrorResponse"},
                                "examples": {
                                    "missingFields": {
                                        "value": {
                                            "errors": {
                                                "jumlah": ["Jumlah pembayaran wajib diisi."],
                                                "metode": ["Metode pembayaran wajib diisi."],
                                                "pembayar": ["Nama pembayar wajib diisi."]
                                            }
                                        }
                                    },
                                    "invalidMetode": {
                                        "value": {"errors": {"metode": ["Metode pembayaran harus Tunai atau Non-Tunai."]}}
                                    },
                                    "invalidJumlahType": {
                                        "value": {"errors": {"jumlah": ["Jumlah pembayaran harus berupa angka."]}}
                                    },
                                    "invalidJumlahMin": {
                                        "value": {"errors": {"jumlah": ["Jumlah pembayaran minimal 1."]}}
                                    },
                                    "pembayarMax": {
                                        "value": {"errors": {"pembayar": ["Nama pembayar maksimal 100 karakter."]}}
                                    },
                                    "overpay": {
                                        "value": {"errors": {"message": ["jumlah pembayaran melebihi sisa/jumlah biaya tagihan."]}}
                                    }
                                }
                            }
                        }
                    },
                    "404": {
                        "description": "Tagihan tidak ditemukan.",
                        "content": {
                            "application/json": {
                                "schema": {"$ref": "#/components/schemas/ErrorResponse"},
                                "example": {"errors": {"message": ["tagihan tidak ditemukan."]}}
                            }
                        }
                    },
                    "401": {
                        "description": "Unauthorized.",
                        "content": {
                            "application/json": {
                                "schema": {"$ref": "#/components/schemas/ErrorResponse"},
                                "example": {"errors": {"message": ["unauthorized."]}}
                            }
                        }
                    }
                }
            }
        },
        "/api/pembayaran/lunas/{kode_tagihan}": {
            "post": {
                "description": "Pembayaran lunas (full).",
                "parameters": [
                    {"$ref": "#/components/parameters/Authorization"},
                    {"$ref": "#/components/parameters/KodeTagihanPath"}
                ],
                "requestBody": {
                    "required": true,
                    "content": {
                        "application/json": {
                            "schema": {"$ref": "#/components/schemas/PembayaranLunasRequest"},
                            "example": {"metode": "Tunai", "pembayar": "Orang Tua"}
                        }
                    }
                },
                "responses": {
                    "200": {
                        "description": "Berhasil membuat pembayaran lunas.",
                        "content": {
                            "application/json": {
                                "schema": {"type": "object", "properties": {"data": {"$ref": "#/components/schemas/Pembayaran"}}},
                                "example": {
                                    "data": {
                                        "kode_pembayaran": "PAY-2511-0201",
                                        "kode_tagihan": {
                                            "kode_tagihan": "TAG-2511-0201",
                                            "jenis_tagihan": {"id": 201, "nama": "SPP Januari", "jatuh_tempo": "2025-01-31", "jumlah": "100000.00"},
                                            "siswa": {"id": 600, "nis": "020200", "nama": "Citra Dewi", "jenjang": "MI", "kelas": {"id": 11, "jenjang": "MI", "nama": "KELAS 2"}, "kategori": {"id": 14, "nama": "Yatim"}},
                                            "tmp": "100000.00",
                                            "status": "Lunas"
                                        },
                                        "tanggal": "2025-11-22",
                                        "metode": "Tunai",
                                        "jumlah": "100000.00",
                                        "pembayar": "Orang Tua"
                                    }
                                }
                            }
                        }
                    },
                    "400": {
                        "description": "Validasi gagal.",
                        "content": {
                            "application/json": {
                                "schema": {"$ref": "#/components/schemas/ValidationErrorResponse"},
                                "examples": {
                                    "missingFields": {
                                        "value": {"errors": {"metode": ["Metode pembayaran wajib diisi."], "pembayar": ["Nama pembayar wajib diisi."]}}
                                    },
                                    "invalidMetode": {
                                        "value": {"errors": {"metode": ["Metode pembayaran harus Tunai atau Non-Tunai."]}}
                                    },
                                    "pembayarMax": {
                                        "value": {"errors": {"pembayar": ["Nama pembayar maksimal 100 karakter."]}}
                                    }
                                }
                            }
                        }
                    },
                    "404": {
                        "description": "Tagihan tidak ditemukan.",
                        "content": {
                            "application/json": {
                                "schema": {"$ref": "#/components/schemas/ErrorResponse"},
                                "example": {"errors": {"message": ["tagihan tidak ditemukan."]}}
                            }
                        }
                    },
                    "401": {
                        "description": "Unauthorized.",
                        "content": {
                            "application/json": {
                                "schema": {"$ref": "#/components/schemas/ErrorResponse"},
                                "example": {"errors": {"message": ["unauthorized."]}}
                            }
                        }
                    }
                }
            }
        },
        "/api/pembayaran/kwitansi/{kode_pembayaran}": {
            "get": {
                "description": "Ambil data kwitansi pembayaran.",
                "parameters": [
                    {"$ref": "#/components/parameters/Authorization"},
                    {"$ref": "#/components/parameters/KodePembayaranPath"}
                ],
                "responses": {
                    "200": {
                        "description": "Berhasil.",
                        "content": {
                            "application/json": {
                                "schema": {"type": "object", "properties": {"data": {"$ref": "#/components/schemas/Kwitansi"}}},
                                "example": {
                                    "data": {
                                        "setting": {"nama_yayasan": "Yayasan ABC", "alamat": "Jl. Contoh No. 1"},
                                        "tanggal": "2025-11-22",
                                        "pembayar": "Orang Tua",
                                        "jumlah": "50000.00",
                                        "untuk": "Pembayaran SPP Januari (cicil)",
                                        "sejumlah": "Lima Puluh Ribu Rupiah"
                                    }
                                }
                            }
                        }
                    },
                    "404": {
                        "description": "Pembayaran tidak ditemukan.",
                        "content": {
                            "application/json": {
                                "schema": {"$ref": "#/components/schemas/ErrorResponse"},
                                "example": {"errors": {"message": ["pembayaran tidak ditemukan."]}}
                            }
                        }
                    },
                    "401": {
                        "description": "Unauthorized.",
                        "content": {
                            "application/json": {
                                "schema": {"$ref": "#/components/schemas/ErrorResponse"},
                                "example": {"errors": {"message": ["unauthorized."]}}
                            }
                        }
                    }
                }
            }
        },
        "/api/pembayaran/{kode_pembayaran}": {
            "delete": {
                "description": "Hapus pembayaran (re-calculate tmp & status tagihan).",
                "parameters": [
                    {"$ref": "#/components/parameters/Authorization"},
                    {"$ref": "#/components/parameters/KodePembayaranPath"}
                ],
                "responses": {
                    "200": {
                        "description": "Berhasil dihapus.",
                        "content": {
                            "application/json": {
                                "schema": {"type": "object", "properties": {"data": {"type": "boolean"}}},
                                "example": {"data": true}
                            }
                        }
                    },
                    "404": {
                        "description": "Pembayaran atau tagihan tidak ditemukan.",
                        "content": {
                            "application/json": {
                                "schema": {"$ref": "#/components/schemas/ErrorResponse"},
                                "examples": {
                                    "pembayaranNotFound": {"value": {"errors": {"message": ["pembayaran tidak ditemukan."]}}},
                                    "jenisTagihanMissing": {"value": {"errors": {"message": ["jenis tagihan tidak ditemukan."]}}}
                                }
                            }
                        }
                    },
                    "400": {
                        "description": "Konsistensi data gagal.",
                        "content": {
                            "application/json": {
                                "schema": {"$ref": "#/components/schemas/ErrorResponse"},
                                "example": {"errors": {"message": ["jumlah pembayaran melebihi akumulasi tagihan yang tersimpan."]}}
                            }
                        }
                    },
                    "401": {
                        "description": "Unauthorized.",
                        "content": {
                            "application/json": {
                                "schema": {"$ref": "#/components/schemas/ErrorResponse"},
                                "example": {"errors": {"message": ["unauthorized."]}}
                            }
                        }
                    }
                }
            }
        }
    }
}
